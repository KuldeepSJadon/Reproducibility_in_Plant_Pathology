---
title: "Assigning articles to evaluators"
author: "Adam H Sparks"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

## Creating a sample of articles

Twenty one journals in the discipline of plant pathology were selected by the four authors as being the primary choice for most plant pathologists when publishing manuscripts.

Using the assumption that journals publish an average 10 articles per issue, for a population of ~1000 articles, using a confidence level of 95% and confidence interval of 10% we need 88 samples. In [Issue #3](https://github.com/adamhsparks/Reproducible-Research-in-Plant-Pathology/issues/3), we decided to select 200 articles to have a large sample of the population.

## R setup
Set up the R environment

```{r library, message=FALSE}
library(dplyr)
library(readr)
library(bib2df)
library(googlesheets)
library(stringr)
library(Reproducible.Plant.Pathology)

set.seed(1)

# For printing tibble in total
options(tibble.print_max = 21, tibble.print_min = 21)
```
## Create list of journals

We hand-picked a list of 21 journals that we felt represented plant pathology research. In this step, we will create a `tibble` in R of these journals, assigning them a number so that we can randomise them.

```{r journal_list}
journal_list <- tibble(
  seq(1:21),
  c("Australasian Plant Pathology",
    "Canadian Journal of Plant Pathology",
    "Crop Protection",
    "European Journal of Plant Pathology",
    "Forest Pathology",
    "Journal of General Plant Pathology",
    "Journal of Phytopathology",
    "Journal of Plant Pathology",
    "Virology Journal (Plant Viruses Section)",
    "Molecular Plant-Microbe Interactions",
    "Molecular Plant Pathology",
    "Nematology",
    "Physiological and Molecular Plant Pathology",
    "Phytoparasitica",
    "Phytopathologia Mediterranea",
    "Phytopathology",
    "Plant Disease",
    "Plant Health Progress",
    "Plant Pathology",
    "Revista Mexicana de FitopatologÃ­a",
    "Tropical Plant Pathology"))

names(journal_list) <- c("number", "publication")
```

## Create list of evaluators

From the four authors of this paper, in this step, we will create a list for us to use that will randomly assign articles for us to evaluate for this manuscript.

```{r assignee}
assignee <- rep(c("Adam", "Emerson", "Zach", "Nik"), 50)

```

## Create randomised list

Now we will create a randomised list of journal articles to assign to each of the four authors for this paper.

### Create a randomised list of the journals

```{r journal_sample}
journals <- tibble::tibble(sample(1:21, 200, replace = TRUE))

names(journals) <- "number"

journals <- dplyr::left_join(journals, journal_list, "number")
```

### Randomly select articles

Generate a random list of years between 2012 and 2016 and a random list of start pages between 1 and 150 since some journals start numbering at 1 with every issue. Then bind the columns of the randomised list of journals with the randomised years and page start numbers. This then assumes that there is no temporal effect, _i.e._, the time of year an article is published does not affect whether or not it is reproducible.


```{r years_and_articles}
year <- sample(2012:2016, 200, replace = TRUE)

start_page <- sample.int(150, 200, replace = TRUE)

journals <- cbind(journals[, -1], year, start_page, assignee)

dplyr::arrange(journals, publication, year, start_page)

```

### Check the number of articles per journal

```{r, count}
journals %>%  
  dplyr::group_by(publication) %>% 
  dplyr::tally(sort = TRUE) 
```

Once this is done, the articles are manually examined for suitability. Reference articles or
off-topic articles are not included. Notes are provided regarding these cases in `assigned_article_notes`. If the selected page number/article was not suitable, the next sequential article was selected manually.


## Add empty columns for data to collect

A variety of information will be collected with each article to be used in the analysis later.
It is easiest to enter this using a spreadsheet application, so we will add on the columns for what information we want to collect and save the table as a csv for manual editing.

```{r}
to_record <- c(
  "doi",
  "if",
  "page_charges",
  "country",
  "open",
  "repro_inst",
  "iss_per_year",
  "art_class",
  "supl_mats",
  "comp_mthds_avail",
  "software_avail",
  "software_cite",
  "anlysis_auto",
  "data_avail",
  "data_annot",
  "data_tidy",
  "reproducibility_score"
  )
  journals[to_record] <- ""
```

## Google Sheets

We decided to use Google Sheets so that we could concurrently edit the file more easily. Once we're done filling in our evaluations, we will import the data back to R. Jenny Bryan has created a handy package, _googlesheets_ that we use here. _Note that this must be run interactively for `gs_new()` to work. Knitting this .Rmd file will not generate any gsheets, it must be done in an interactive R session._

Create a Google Sheets workbook to hold worksheets for this project. This first sheet will serve as a template.

```{r setup_gs, eval=FALSE}
# Give googlesheets permission to access spreadsheets and Google Drive
gs_auth()

# create Google Sheet for concurrent edits, first sheet: article notes template
gs_new(
  "article_notes",
  ws_title = "template",
  input = journals,
  trim = TRUE,
  verbose = FALSE
  )
```

## Add article DOI's

This step is completed in gsheets, Adam looked up articles and added notes and DOIs to a gsheet, "article_notes" which will be read into R in the next step.

## Generate a bibliography file to use with the paper

Using the DOIs in this file, we can retrieve the BibTex citations for those articles that provide a DOI. Note that not all of the selected articles have a DOI, so we'll have to manually generate those entries, or fetch them from the journals' website later.

```{r join_files, warning=FALSE, message=FALSE, results="hide", eval=FALSE}
article_notes <- gs_title("article_notes")

notes <- 
  article_notes %>% 
    gs_read(ws = "article_notes")
  
notes$doi <- tolower(notes$doi) # format DOIs to all be uniform, lower-case
notes$journal <- iconv(notes$journal, "latin1", "UTF-8") # convert encodings for text with accents

bib <- unlist(lapply(notes$doi, doi2bib)) # get bib references from the DOI (that exist)
```

The Journal of Plant Pathology does not supply valid bib entries via the DOI. So we need to clean them up.

```{r clean_bib, warning=FALSE, message=FALSE, results="hide", eval=FALSE}
# locations of Journal of PLant Pathology entries in bib object
clean <- grep("journal=\\{Journal of Plant Pathology\\}", bib)

# create a dataset of just those bib entries
bib_clean <- bib[clean]

# function to clean the entries
clean_arts <- function(x) {
  title_loc <- unlist(gregexpr(pattern = "title", x))
  y <- substr(x, start = title_loc[1], stop = nchar(x))
  y <- paste0(" @article{jpp,\n\t" , y)
  y <- gsub("}, ", "},\n\t", y)
  y <- gsub("=", " = ", y)
  y <- gsub("}}\n", "}\n}", y)
}

# apply function and clean the bib entries
cleaned <- unlist(lapply(bib_clean, clean_arts))

# remove the bad entries
bib <- bib[bib != "Invalid DOI"]
bib <- bib[-clean]

# fix the "year" field so that it has brackets, necessary later to reimport as data frame
bib <- gsub("year = ", "year = {", bib, fixed = TRUE)
bib <- gsub(",\n\tmonth", "},\n\tmonth", bib, fixed = TRUE)
bib <- gsub(",\n\tpublisher", "},\n\tpublisher", bib, fixed = TRUE)

# fix the "month"" field
bib <- gsub("}},\n\tpublisher", "},\n\tpublisher", bib, fixed = TRUE)

# put the cleaned entries back in
bib <- c(bib, cleaned)
```

Next create a data frame of the references and export to Google.

```{r google, warning=FALSE, message=FALSE, results="hide", eval=FALSE}
# write to a temp directory and read back as a tibble
bib <- unlist(bib)
lapply(bib, write, "~/tmp/article_notes.bib", append = TRUE)
parsed_bib <- bib2df("~/tmp/article_notes.bib")
names(parsed_bib) <- tolower(names(parsed_bib))

# remove an extra "}" in the month column
parsed_bib[[5]] <- gsub("}", "", parsed_bib[[5]])

# join notes with bibliographic data
bib_df <- left_join(parsed_bib, notes, by = c("doi" = "doi",
                                              "journal" = "journal"))
bib_df <- arrange(bib_df, assignee)

# create Google Sheet for concurrent edits
article_notes <-
  article_notes %>%
    gs_ws_new(
    ws_title = "article_evaluations",
    input = bib_df,
    trim = TRUE,
    verbose = FALSE
    )

```

## Last steps

The last few steps are completed outside of R in Google Docs, manually adding the missing information to the spreadsheet and the assignees adding their evaluations of their respective articles.

